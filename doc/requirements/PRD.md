# Tale Draw - AI故事绘本生成器 产品需求文档 (PRD)

## 产品概述

Tale Draw 是一个基于 React 的 AI 驱动的故事绘本生成器，使用 Google Gemini 2.5-flash 和 Imagen 3/4 技术，为用户的故事自动生成结构化内容和精美插图。

## 核心功能流程

### 1. 用户输入与认证 ✅
- **Firebase 认证**：邮箱/密码登录注册系统
- **故事输入**：支持多语言文本输入（中文、英文、日文等），最大2000字
- **智能参数配置**：
  - 页数选择：1-30页（默认10页）
  - 宽高比选择：1:1, 9:16, 16:9, 3:4, 4:3（默认1:1）
  - 角色管理：自动提取或手动设置

### 2. AI 故事分析与结构化 ✅
**技术栈**：Gemini 2.5-flash 通过 Firebase Functions 调用
- **智能分析**：故事结构、关键情节、角色信息
- **内容安全优化**：自动转换不当内容为儿童友好内容
- **角色一致性管理**：提取角色外观、服装、性格特征
- **页面分配**：智能分配故事内容到指定页数
- **流式生成**：支持实时进度显示和用户中断

### 3. 图像生成系统 ✅
**技术栈**：Imagen 3/4 通过 Firebase Functions 调用
- **多版本支持**：支持 Imagen 3 和 Imagen 4 两个版本
- **智能场景识别**：
  - 无角色场景：纯环境描述
  - 主角场景：突出主要角色
  - 配角场景：展示次要角色
  - 群体场景：多角色互动
- **风格一致性**：使用种子值确保全书风格统一
- **安全过滤**：内容安全检查，确保儿童友好
- **高级参数**：支持负向提示词、安全过滤级别、人物生成控制
- **多模型支持**：支持 `Imagen4-fast`, `Imagen4`, `Imagen3` 等多种图像生成模型，并提供未来可扩展的统一接口
- **失败原因反馈**：返回图像生成失败的具体原因（如内容安全策略），便于用户调整

### 4. 交互式编辑功能 ✅
- **实时预览**：故事页面即时显示
- **工作流程状态**：显示工作流程日志，可在工作流程面板暂停或停止生成任务
- **图像重新生成**：单页图像重新生成功能
- **提示词编辑**：用户可编辑和优化图像生成提示词
- **模型选择器**：在宽高比选择器旁增加模型下拉菜单，允许用户在 `Imagen4-fast` (默认), `Imagen4`, `Imagen3` 之间切换
- **状态管理**：生成中、成功、失败状态可视化
- **图像查看**：
  - 沉浸式查看模式：黑色主题背景，最大化图像显示区域
  - 智能布局：横向图片采用上中下布局（标题-图片-文本），纵向图片采用左右布局（左侧文本-右侧图片）
  - 键盘导航：支持左右方向键翻页浏览，ESC键关闭
  - 性能优化：使用本地缓存数据，避免重复下载

### 5. 导出与保存 ✅
- **多格式导出**：
  - HTML：完整网页格式，支持图片Base64嵌入，完全离线查看
    - 图像全屏查看：点击图片进入沉浸式全屏模式
    - 智能布局：根据图片宽高比自动调整布局（横向/纵向）
    - 键盘导航：支持方向键翻页，ESC键退出
    - 触摸手势：支持移动端滑动翻页
    - 性能优化：图片预加载，流畅切换
    - 响应式设计：自适应桌面和移动设备
  - PPTX：PowerPoint演示文稿格式，16:9 1080p标准尺寸
    - 实际图片比例检测：自动检测每张图片的真实长宽比
    - 智能图文布局：根据实际图片比例自动调整排版
    - 优化文字排版：增大字体、改善边距、顶部对齐
    - 自适应字体：根据文字长度动态调整字体大小
    - 专业设计：封面页、标题栏、合理边距
    - 图片保护：保持原始长宽比，无拉伸裁剪
- **云存储**：Firebase Storage 自动保存生成的图像
- **数据持久化**：支持 Cloud Storage 和 Firestore 两种存储模式
- **状态恢复**：页面刷新后自动恢复绘本状态（24小时有效期）

## 技术架构

### 前端 (React) ✅
```
用户界面组件：
├── App.js (主应用逻辑)
├── components/
│   ├── PageSelector.js (页数选择器)
│   ├── AspectRatioSelector.js (宽高比选择器)
│   ├── CharacterManager.js (角色管理器)
│   └── PageItem.js (页面展示组件)
├── api.js (API调用封装)
├── config.js (前端配置管理)
├── firebase.js (Firebase初始化)
├── stateManager.js (状态持久化管理)
└── auth.js (认证状态管理)
```

### 后端 (Firebase Functions) ✅
```
云函数服务：
├── generateTaleStream (流式故事结构生成)
├── getTaleData (获取故事数据)
├── generateImage (Imagen 3/4图像生成)
├── config.js (统一配置管理)
└── healthCheck (健康检查)
```

### 数据流程 ✅
```
用户输入 → Firebase Auth → Gemini分析 → 结构化数据 → 
Cloud Storage/Firestore → 前端展示 → Imagen生成 → Firebase Storage → 最终展示
```

### 编码规范
- **字符编码**：为避免中文乱码，所有HTTP通信的 `Content-Type` 头必须明确指定 `charset=UTF-8`，尤其是在流式API中。

## 内容安全特性 ✅

### 多层安全保护
1. **LLM层面**：Gemini自动内容过滤和友好转换
2. **提示词层面**：内置安全词汇替换机制
3. **图像生成层面**：安全过滤设置和负向提示词
4. **输出层面**：儿童友好内容验证

### 安全转换规则
- 暴力内容 → 友好竞赛或讨论
- 恐怖元素 → 神秘冒险或有趣挑战
- 负面情绪 → 困惑或需要帮助
- 危险活动 → 安全的监督下探索
- 刻板印象 → 包容性和多样化描述

## 用户体验特性 ✅

### 实时反馈系统
- **进度追踪**：详细的生成步骤显示
- **日志系统**：完整的操作日志记录
- **状态指示**：清晰的加载、成功、错误状态
- **错误处理**：友好的错误信息和重试机制

### 智能优化
- **自动重试**：API调用失败自动重试机制
- **内容压缩**：gzip压缩减少存储空间
- **缓存策略**：智能缓存提升性能
- **响应式设计**：支持多设备访问
- **状态持久化**：页面刷新后自动恢复工作状态

## 配置与部署 ✅

### 环境配置
- **开发环境**：Cloud Storage模式，快速迭代
- **生产环境**：Firestore模式，数据持久化
- **API配置**：统一的配置管理系统
- **安全设置**：CORS配置和认证检查

### 性能优化
- **函数配置**：2GiB内存，15分钟超时
- **并发控制**：智能并发限制避免API限制
- **错误恢复**：指数退避重试策略
- **资源管理**：自动清理临时文件


## 待实现
- ❌ 用户历史记录功能
- ❌ 角色形象预设功能
- ❌ 模板系统 
- ❌ 多语言支持
- ❌ 社区功能
- ❌ 高级编辑

## 版本信息
- **当前版本**：v0.4.2
- **最新更新**：图像查看器界面重大优化，沉浸式黑色主题，智能字体大小调整，自动隐藏UI元素，提供更专业的阅读体验
- **支持的AI模型**：
  - Gemini 2.5-flash (故事分析)
  - Imagen 3.0-generate-002 (图像生成)
- **部署平台**：Firebase (Functions + Storage + Auth)
- **前端框架**：React 19 with Create React App

## 技术依赖
- **前端**：React 19.1.0, Firebase SDK 11.9.1
- **后端**：Node.js 22, Firebase Functions 6.3.2, Firebase Admin 12.0.0
- **AI服务**：Google Vertex AI (Gemini & Imagen)
- **存储**：Firebase Storage & Firestore
- **认证**：Firebase Authentication

## 未来规划
1. **用户历史记录**：用户历史记录功能，便于用户查看和管理自己的绘本
2. **角色形象预设**：角色形象预设功能，便于多个绘本统一角色
3. **模板系统**：预设故事模板和风格
4. **移动应用**：React Native移动端适配
5. **多语言界面**：完整的多语言界面支持
6. **社区功能**：用户分享和社区交互
7. **高级编辑**：更多图像编辑和调整选项
