# Firebase Functions 性能与成本优化指南

本文档旨在为 Tale Draw 项目的后端 Firebase Functions 提供性能和成本优化的指导方针和待办事项。

## ✅ 已完成：Firebase Functions v2 转换

**状态**: 已完成 (2024年)
**详情**: 所有 Firebase Functions 已成功从 v1 转换为 v2，包括：
- 统一使用 `onCall` 和 `onRequest` v2 语法
- 移除了 `firebase-functions/v1` 依赖
- 支持更长的超时时间（最长15分钟）
- 更好的性能和可扩展性

## 1. 内存资源优化

**核心原则**: 避免为所有函数统一分配高额内存 (如 2GB)，应根据每个函数的具体任务和资源消耗来精细化配置。这不仅能显著降低运营成本，还可能提升轻量级任务的冷启动速度。

### 1.1 函数内存分配建议

以下是基于当前函数功能的初步内存分配建议。最终配置应通过实际监控数据来验证和调整。

| 函数 (Function)             | 推荐内存        | 已应用内存 | 已应用超时 | 理由和说明                                                                                                                     | 状态                  |
| :-------------------------- | :-------------- | :--------- | :------------- | :----------------------------------------------------------------------------------------------------------------------------- | :-------------------- |
| `generateTale`              | **512MB - 1GB** | `1GB`      | `300s`         | 主要为 I/O 密集型任务 (调用 Gemini)，流式处理后自身内存消耗低。                                                                | `已优化 (v2完成)` |
| `getTaleData`               | **256MB**       | `256MB`    | `60s`          | 简单的数据库/存储读取操作，是典型的轻量级任务。                                                                                | `已优化 (v2完成)` |
| `generateImage`             | **512MB - 1GB** | `1GB`      | `300s`         | 调用 Imagen API，属于 I/O 密集型。流式优化降低了内存压力。                                                                      | `已优化 (v2完成)` |
| `generateImageV4`           | **512MB - 1GB** | `1GB`      | `300s`         | 调用 Imagen 4 API，同样是 I/O 密集型任务。                                                                                      | `已优化 (v2完成)` |
| `extractCharacter`          | **512MB**       | `512MB`    | `120s`         | 调用 Gemini，任务比 `generateTale` 更简单，数据量更小。                                                                          | `已优化 (v2完成)` |
| `generateImageBatch`        | **1GB - 2GB**   | `2GB`      | `900s`         | **[重点监控对象]** 这是一个长时间运行的串行任务，为确保大型绘本（如30页）能完整生成，将超时设置为15分钟。 | `已优化 (v2完成)` |
| `generateImageBatchV4`      | **1GB - 2GB**   | `2GB`      | `900s`         | **[重点监控对象]** Imagen 4 批量处理，同样需要长超时支持大型任务。                                                              | `已优化 (v2完成)` |
| `generateTaleStream`        | **512MB - 1GB** | `1GB`      | `300s`         | 流式故事生成，I/O 密集型，内存需求适中。                                                                                        | `已优化 (v2完成)` |
| `healthCheck`               | **128MB**       | `128MB`    | `60s`          | 逻辑最简单，应使用最低可用内存配置。                                                                                           | `已优化 (v2完成)` |

### 1.2 如何验证和微调内存分配

1.  **访问 Google Cloud Console**: 
    - 导航到 Cloud Functions
    - 选择特定函数
    - 查看 "Metrics" 标签页

2.  **关键指标监控**:
    - **内存使用率**: 观察峰值使用情况
    - **执行时间**: 检查是否因内存不足导致性能下降
    - **错误率**: 监控 OOM (Out of Memory) 错误

3.  **调整策略**:
    - 如果内存使用率长期低于50%，可以考虑降低分配
    - 如果出现 OOM 错误或执行时间异常长，需要增加内存
    - 建议保留 20-30% 的内存缓冲区

## 2. 其他优化方向 (待办事项)

### 2.1 CPU 资源优化 (待实施)

**当前状态**: `待分析`
**优化目标**: 根据函数的计算密集度调整 vCPU 分配

- **计算密集型函数**: 考虑增加 CPU 分配
- **I/O 密集型函数**: 可以使用较少的 CPU 资源
- **建议**: 监控 CPU 使用率，优化 CPU/内存比例

### 2.2 超时设置优化 (已完成)

**当前状态**: `已优化`
**详情**: 
- ✅ 批量处理函数已设置为 15分钟 (900秒)
- ✅ 轻量级函数设置为 1-2分钟
- ✅ 中等复杂度函数设置为 5分钟

### 2.3 最小实例数优化 (待实施)

**当前状态**: `待评估`
**优化目标**: 为高频访问函数设置"温热"实例

**候选函数**:
- `healthCheck`: 可能需要快速响应
- `getTaleData`: 用户查看历史数据时需要快速加载

**注意事项**: 
- 最小实例数会产生持续成本
- 需要根据实际访问模式权衡成本与性能

### 2.4 并发控制优化 (未来规划)

**当前状态**: `规划中`
**优化目标**: 升级到 Firebase Functions 第二代并发特性

**潜在收益**:
- 单个实例处理多个并发请求
- 降低冷启动频率
- 提高资源利用率

## 3. 成本监控建议

### 3.1 关键成本指标

1.  **调用次数**: 监控每月调用量，确保在免费额度内
2.  **计算时间**: 重点关注长时间运行的批量函数
3.  **网络流量**: 监控图像上传/下载产生的流量成本

### 3.2 成本优化策略

1.  **批量处理优化**: 减少单次调用的开销
2.  **缓存策略**: 避免重复计算和API调用
3.  **错误处理**: 快速失败，避免资源浪费

## 4. 监控和告警设置

### 4.1 推荐告警规则

1.  **内存使用率 > 90%**: 提示需要增加内存分配
2.  **执行时间 > 预期 150%**: 可能存在性能问题
3.  **错误率 > 5%**: 需要立即调查
4.  **成本增长 > 50%**: 月度成本异常增长告警

### 4.2 定期审查计划

- **每周**: 检查函数执行指标和错误日志
- **每月**: 审查成本报告和资源使用情况
- **每季度**: 重新评估内存和超时配置的合理性

---

**最后更新**: 2024年
**下次审查**: 建议在生产环境运行2-4周后进行首次全面审查

# Tale Draw 性能优化记录

## 最新优化 (2025-01-21)

### HTML导出功能优化 🔥

#### 核心问题修复
- **图片转换失败**：Canvas CORS错误导致所有图片转换失败
- **并发处理问题**：浏览器并发限制导致批量转换超时
- **文件大小异常**：图片未嵌入导致HTML文件仅0.01MB，需要网络连接

#### 解决方案
1. **转换方法改进**：
   - 从Canvas方法改为Fetch API方法，完全绕过CORS限制
   - 从并发处理改为顺序处理，避免浏览器并发限制
   - 超时时间从10秒增加到30秒

2. **技术实现**：
   - 使用`fetch(imageUrl)`直接获取图片数据
   - 转换为Blob再转为Base64 dataURL
   - 添加100ms间隔防止请求过频

3. **用户体验**：
   - 详细的转换进度反馈
   - 文件大小实时显示
   - 独立错误处理确保单个失败不影响整体

#### 优化效果
- ✅ 图片转换成功率：0% → 100%
- ✅ HTML文件大小：0.01MB → 10-25MB（完整嵌入）
- ✅ 支持完全离线查看，无需网络连接
- ✅ 服务器流量消耗：大幅降低